"use strict";angular.module("bloqusApp",["ngAnimate","ngMessages","ngCookies","ngResource","ui.router","ngSanitize","ngTouch","firebase","firebase.ref","LocalStorageModule","ui.bootstrap","ui.bootstrap.tabs","ang-drag-drop"]),angular.module("firebase.config",[]).constant("FBURL","https://bloqus.firebaseio.com"),angular.module("firebase.ref",["firebase","firebase.config"]).factory("Ref",["$window","FBURL",function(a,b){return new a.Firebase(b)}]),angular.module("bloqusApp").controller("MainCtrl",["$scope","$state","SignInFactory","$firebaseObject",function(a,b,c,d){var e,f,g,h=d(new Firebase("https://bloqus.firebaseio.com/"));a["private"]=!1,h.$bindTo(a,"firebase"),h.$loaded().then(function(){a.createGame=function(){var d=Math.round(1e8*Math.random()),e=Math.round(1e5*Math.random()),f=a.hostname;a.firebase=c.createGame(d,e,f,a["private"]),a.firebase.$save(),$(".modal-backdrop").remove(),b.go("lobby",{currentId:d,shareId:e})},a.checkGameId=function(b){var h=c.checkGameId(b);h?(e=h.shareId,f=h.currentGameId,g=d(new Firebase("https://bloqus.firebaseio.com/games/"+f)),a.foundGame=h.foundGame):(a.gameDoesNotExist=!0,$("#join-game-modal").modal("hide"))},a.enterGame=function(a){c.enterGame(a,f,e),$(".modal-backdrop").remove(),b.go("lobby",{currentId:f,shareId:e})},a.findPublicGame=function(){var b=c.findPublicGame();b?(e=b.shareId,f=b.currentGameId,g=d(new Firebase("https://bloqus.firebaseio.com/games/"+f)),a.foundGame=b.foundGame):(a.publicDoesNotExist=!0,$("#join-game-modal").modal("hide"))}})}]),angular.module("bloqusApp").controller("LobbyCtrl",["$rootScope","$scope","$state","$stateParams","$firebaseObject","localStorageService","LobbyFactory",function(a,b,c,d,e,f,g){var h,i=new Firebase("https://bloqus.firebaseio.com/"),j=e(i),k=f.get("name"),l=(f.get("id"),f.get("color"));b.currentId=d.currentId,b.playerName=k,j.$bindTo(b,"firebase"),j.$loaded().then(function(){h=d.currentId;var i=e(new Firebase("https://bloqus.firebaseio.com/games/"+h));b.currentId=h,b.shareId=d.shareId,b.currentPlayers=i.player,b.gridDimensions=i.dimensions,b.polyNum=i.polyominoNum,b.numColors=i.numColors,b.isHost=f.get("host")==h,b.switchToColor=function(a){b.firebase=g.switchToColor(l,a,h),l=a},b.takeOver=function(a){b.firebase=g.takeOver(l,a,h)},b.dropControl=function(a){b.firebase=g.dropControl(a,h)},b.setNumOfPlayers=function(a){b.firebase=g.setNumOfPlayers(a,h)},b.setPolyomino=function(a){b.polyNum=a,b.firebase=g.setPolyomino(a,h)},b.setDimensions=function(a){b.gridDimensions=a,b.firebase=g.setDimensions(a,h)},b.startGame=function(){console.log("Went to game."),b.firebase.games[h].status="start",c.go("gameboard",{game:{firebaseId:h,player:k}})};var j=i.$watch(function(){"start"===i.status&&i.$save().then(function(){j(),console.log("Went to game."),c.go("gameboard",{game:{firebaseId:h,player:k}})}),"deleted"===i.status&&(j(),c.go("main",{error:"Host Left, Game Aborted."})),b.currentPlayers=i.player,b.numColors=i.numColors,b.polyNum=i.polyominoNum,b.gridDimensions=i.dimensions});a.$on("$stateChangeStart",function(a,c,d,e){"gameboard"!==c.name&&"lobby"===e.name&&b.isHost&&(console.log("Host Left!"),i.status="deleted",i.$save().then(function(){setTimeout(function(){i.$remove()},2e3)})),"gameboard"!==c.name&&"lobby"===e.name&&(b.firebase=g.playerLeftLobby(l,h))})})}]),angular.module("bloqusApp").controller("ChatCtrl",["$scope","$firebaseArray","localStorageService",function(a,b,c){var d=new Firebase("https://bloqus.firebaseio.com/messages/"+a.current),e=$("#messageInput"),f=$("#example-messages");e.keypress(function(a){if(13==a.keyCode){var b=c.get("name"),f=": "+e.val();d.push({name:b,text:f}),e.val("")}}),d.limitToLast(10).on("child_added",function(a){var b=a.val(),c=b.name||"anonymous",d=b.text,e=$("<li>"),g=$("<strong></strong>");g.text(c),e.text(d).prepend(g),f.append(e),f[0].scrollTop=f[0].scrollHeight})}]),angular.module("bloqusApp").controller("NavCtrl",["$scope","$rootScope","$state",function(a,b,c){a.$watch(function(){"main"==c.current.name?a.hideNav=!0:a.hideNav=!1})}]),angular.module("bloqusApp").controller("GameCtrl",["$sce","$rootScope","$scope","$stateParams","GameFactory","LogicFactory","localStorageService","$state","ScoreFactory",function(a,b,c,d,e,f,g,h,i){var j,k,l,m,n,o,p=20;c.userColor=g.get("color"),e.setGameFactory(d.game.firebaseId,d.game.player),c.rotate=function(a){console.log(a);var b=n[a];b.rotateClockwise(),c.renderMyPieces(n)},c.flip=function(a){console.log(a);var b=n[a];b.flip(),c.renderMyPieces(n)},c.pass=function(){b.$emit("passTurn")},c.dropPiece=function(a,d){var e=a.originalEvent.x,g=a.originalEvent.y,h=angular.element(document.querySelector("#frame")).prop("offsetLeft"),i=angular.element(document.querySelector("#frame")).prop("offsetTop");console.log("coords",e,g);var k=a.currentTarget.clientHeight,n=void 0!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop,o=e-h,q=g-i-k+n,r=Math.round(o/p),s=Math.round(q/p);if(-1!==l.indexOf(m)){var t=new f.Move(d.piece,[s,r],m.toUpperCase().charAt(0));j.doMove(t),c.boardGrid=j.getBoard();var t=new f.Move(d.piece,[s,r],m.toUpperCase().charAt(0));b.$emit("makeMove",t)}},c.makeMove=function(){if(-1!==l.indexOf(m)){var a=j.allLegalMovesForPieces(k[m],m.toUpperCase().charAt(0)),c=Math.floor(Math.random()*a.length),d=a[c];b.$emit("makeMove",d)}};var q=b.$on("gameOver",function(a,b){console.log("HEARD THE GAME WAS OVER?"),q(),r(),h.go("gameover",{game:b})}),r=b.$on("stateChanged",function(a,b,d,e,f){j=b,k=d,l=e,m=f,c.boardGrid=b.getBoard(),c.scores=i(c.boardGrid);for(var g=["blue","yellow","red","green"],h=g.indexOf(f);8>h;h++){var p=h%4;if(-1!==e.indexOf(g[p])){o=g[p];break}}n=d[o],c.renderMyPieces(n),c.currentColor=f});c.renderMyPieces=function(a){for(var b=a,d=[],e=0;e<b.length;e++){for(var f=[],g=b[e].getPieceWithOrientation(),h=g.reduce(function(a,b){return Math.max(a,b[0],b[1])},0),i=0;h>=i;i++){f.push([]);for(var j=0;h>=j;j++){var k=g.some(function(a){return a[0]==i&&a[1]==j});f[i].push(k?o.toUpperCase().charAt(0):"T")}}d.push({grid:f,piece:b[e]})}c.pieces=d}}]),angular.module("bloqusApp").directive("chat",function(){return{restrict:"E",templateUrl:"scripts/directives/chat.html",controller:"ChatCtrl",scope:{current:"="},link:function(a,b,c){}}}),angular.module("bloqusApp").directive("ngRightClick",["$parse",function(a){return function(b,c,d){var e=a(d.ngRightClick);c.bind("contextmenu",function(a){b.$apply(function(){a.preventDefault(),e(b,{$event:a})})})}}]),angular.module("bloqusApp").factory("SignInFactory",["$firebaseObject","localStorageService",function(a,b){var c=new Firebase("https://bloqus.firebaseio.com/"),d=a(c),e=function(a){return d.games[a].polyominoNum},f=function(a){for(var b="",c=0;a>c;c++){if(c===a-1)return b+=c;b+=c+"|"}},g={4:f(9),5:f(21),6:f(56)},h=function(a){var b=!0;return angular.forEach(d.games[a].player,function(a,c){return b&&a.isAI===!0&&(b=!1),!1}),!0},i={boardBuilder:function(a){for(var b={},c="",d="",e=0;a>e;e++)c+="N";for(var f=0;a>f;f++)d="row"+f,b[d]=c;return b},createGame:function(a,c,e,f){var g=Math.round(1e8*Math.random());return d.games||(d.games={}),d.games[a]={id:c,board:i.boardBuilder(20),status:"lobby",turnCounter:0,host:e,privateGame:f,polyominoNum:5,dimensions:20,currentTurn:"blue",numColors:4,player:{blue:{name:e,id:g,pieces:"0|1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|18|19|20",hasPassed:!1,isAI:!1},yellow:{name:"Computer",id:"compId",pieces:"0|1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|18|19|20",hasPassed:!1,isAI:!0},green:{name:"Computer",id:"compId",pieces:"0|1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|18|19|20",hasPassed:!1,isAI:!0},red:{name:"Computer",id:"compId",pieces:"0|1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|18|19|20",hasPassed:!1,isAI:!0}}},d.players||(d.players={}),d.players[g]={game:c,name:e},b.clearAll(),b.set("name",e),b.set("id",g),b.set("color","blue"),b.set("host",a),b.set("gameId",a),d},checkGameId:function(a){var b;return angular.forEach(d.games,function(c,d){c.id==a&&(b={shareId:c.id,currentGameId:d,foundGame:!0})}),b},findPublicGame:function(){var a;return angular.forEach(d.games,function(b,c){0==b.privateGame&&"lobby"===b.status&&h(c)&&(a={shareId:b.id,currentGameId:c,foundGame:!0})}),a},enterGame:function(a,c,f){var h=Math.round(1e8*Math.random()),i=e(c);d.players||(d.players={});var j=!0;angular.forEach(d.games[c].player,function(e,k){j&&e.isAI&&(d.games[c].player[k]={name:a,isAI:!1,id:h,hasPassed:!1,pieces:g[i]},j=!1,d.players[h]={game:f,name:a},b.clearAll(),b.set("name",a),b.set("id",h),b.set("color",k))}),d.$save()},switchToColor:function(a,c,e){return d.games[e].player[c]=d.games[e].player[a],d.games[e].player[a]={name:"Computer",id:"compId",pieces:{has:"somePieces"},hasPassed:!1,isAI:!0},b.set("color",c),d}};return i}]),angular.module("bloqusApp").factory("GameFactory",["$rootScope","$firebaseObject","localStorageService","LogicFactory","AgentFactory",function(a,b,c,d,e){var f,g,h,i,j,k,l,m;return{setGameFactory:function(a,d){var e=this,a=a||c.get("fbGameId");f=d||c.get("playerName"),m=b(new Firebase("https://bloqus.firebaseio.com/games/"+a)),m.$loaded().then(function(){e.initialize(),e.emitState(),c.isSupported&&(c.set("fbGameId",a),c.set("playerName",f))})},amHost:function(){return Object.keys(m.player).some(function(a,b,c){return-1!==g.indexOf(a)&&m.player[a].name==m.host})},isComputersTurn:function(){return m.player[m.currentTurn].isAI},currentPlayer:function(){return m.player[m.currentTurn]},emitState:function(){console.log("Change ocurred in database.");var b=this.createBoard(m),c=this.allPieces();if(l=m.currentTurn,h=Object.keys(c).reduce(function(a,b){return a=g.indexOf(b)?a[b]=c[b]:a},{}),a.$emit("stateChanged",b,c,g,l),this.allPlayersHavePassed())return i=0,i.set("localTurnCounter",0),console.log("Everything ends."),void a.$emit("gameOver",b);if(this.amHost())if(console.log("Hey, I'm the host."),m.player[l].hasPassed){console.log("It is the turn of ",l,", who is passing.");var d=(k.indexOf(m.currentTurn)+1)%k.length;m.currentTurn=k[d],m.turnCounter++,m.$save()}else this.isComputersTurn()?(console.log("It is the turn of computer ",l," who has not yet passed."),this.doComputerTurn()):console.log("It is a human's turn.")},doComputerTurn:function(){console.log("Computer turn has started.");var a=this.currentPlayer(),b=a.name,c=this.createBoard(m),d=this.allPieces(),f=Object.keys(m.player).filter(function(b,c,d){return m.player[b].name==a.name}),g=-1==e.AgentNames().indexOf(a)?"Default":b,h=e.Agent(g)(c,d,f,l);if(0==h.pass){var i=c.doMove(h.move);if(i){console.log("The computer moves.");var n=c.emitFire();m.board=n,m.player[l].pieces=m.player[l].pieces.split("|").filter(function(a,b,c){return!j[a].sameShapeAtAll(h.move.piece)}).join("|");var o=(k.indexOf(m.currentTurn)+1)%k.length;m.currentTurn=k[o],m.turnCounter++,m.$save()}}else{console.log("The computer decides to pass for the first time."),m.player[m.currentTurn].hasPassed=!0;var o=(k.indexOf(m.currentTurn)+1)%k.length;m.currentTurn=k[o],m.turnCounter++,m.$save()}},isPlayersTurn:function(){return console.log(g),console.log(m.currentTurn),-1!==g.indexOf(m.currentTurn)},allPlayersHavePassed:function(){var a=!0;return angular.forEach(m.player,function(b,c){b.hasPassed===!1&&(a=!1)}),a},createBoard:function(a){var b=new d.Board(a.dimensions);return b.consumeFire(a.board),b.currentTurn=a.currentTurn,b},allPieces:function(){for(var a={},b=0;b<k.length;b++)a[k[b]]=m.player[k[b]].pieces.split("|").map(function(a){return j[a]});return a},initialize:function(){var b=!0,c=this;j=d.PiecesGenerator(m.polyominoNum),k=4==m.numColors?["blue","yellow","red","green"]:["blue","red"],g=k.filter(function(a){return m.player[a].name==f}),m.status="playing",i=m.turnCounter,m.$watch(function(){console.log("WATCH:"),console.log("Local: ",i),console.log("DB: ",m.turnCounter),i==m.turnCounter-1&&(console.log("A turn for stuff."),i++,b=!1,c.emitState())});var e=function(a,b){if(console.log("'Move' event caught."),c.isPlayersTurn()){console.log("It's your turn.");var d=c.createBoard(m),e=d.doMove(b);if(console.log("Move,",b),e){console.log("Move worked.");var f=d.emitFire();m.board=f,m.player[m.currentTurn].pieces=m.player[m.currentTurn].pieces.split("|").filter(function(a,c,d){return!j[a].sameShapeAtAll(b.piece)}).join("|");var g=(k.indexOf(m.currentTurn)+1)%k.length;console.log("Current index ",g),m.currentTurn=k[g],m.turnCounter++,m.$save()}}},h=function(){if(console.log("'Passing' event caught."),c.isPlayersTurn()){m.player[m.currentTurn].hasPassed=!0;var a=(k.indexOf(m.currentTurn)+1)%k.length;m.currentTurn=k[a],m.turnCounter++,m.$save()}};a.$on("makeMove",e),a.$on("passTurn",h)}}}]),angular.module("bloqusApp").factory("LobbyFactory",["$firebaseObject","localStorageService","SignInFactory",function(a,b,c){var d,e=new Firebase("https://bloqus.firebaseio.com/"),f=a(e),g={name:"Computer",id:"compId",pieces:"0|1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|18|19|20",hasPassed:!1,isAI:!0},h={playerLeftLobby:function(a,b){return f.games[b].player[a]=g,f.$save()},generatePolyominoString:function(a){for(var b="",c=0;a>c;c++){if(c===a-1)return b+=c;b+=c+"|"}},switchToColor:function(a,c,d){return f.games[d].player[c]=f.games[d].player[a],f.games[d].player[a]=g,b.set("color",c),f},takeOver:function(a,b,c){return"Computer"===f.games[c].player[a].name?f.games[c].player[b]=d:f.games[c].player[b]=f.games[c].player[a],f},dropControl:function(a,b){return d=f.games[b].player[a],f.games[b].player[a]=g,f},setNumOfPlayers:function(a,b){return 2===a?(f.games[b].player.yellow=null,f.games[b].player.green=null,f.games[b].numColors=2):(f.games[b].player.yellow=g,f.games[b].player.green=g,f.games[b].numColors=4),f},setDimensions:function(a,b){return f.games[b].dimensions=a,f.games[b].board=c.boardBuilder(a),f},setPolyomino:function(a,b){var c={4:h.generatePolyominoString(9),5:h.generatePolyominoString(21),6:h.generatePolyominoString(56)};return f.games[b].polyominoNum=a,angular.forEach(f.games[b].player,function(b,d){b.pieces=c[a]}),f}};return h}]),angular.module("bloqusApp").factory("AgentFactory",["LogicFactory",function(a){var b=function(a,b,c,d){var e=b[d],f=a.allLegalMovesForPieces(e,d.toUpperCase().charAt(0));if(f.length>0){var g=f[Math.floor(f.length*Math.random())];return{pass:!1,move:g}}return{pass:!0,move:null}},c=function(b,c,d,e){var f=c[e];if(0==f.length||void 0==f[0])return{pass:!0,move:null};console.log(" length for mypieces ",f),console.log("current ",e.toUpperCase().charAt(0)),console.log(" selves ",d);var g=b.allLegalMovesForPieces(f,e.toUpperCase().charAt(0));if(console.log("All moves length for ",g.length,e),0==g.length)return{pass:!0,move:null};var h=function(c){var d=new a.Board(b.dimensions);d.consumeFire(b.emitFire()),d.doMove(c);var f=d.liberties(e.toUpperCase().charAt(0)),g=f.length,h=[Math.round(b.dimensions/2),Math.round(b.dimensions/2)],i=f.reduce(function(a,b){return a+=Math.sqrt(Math.pow(h[0]-b[0],2)+Math.pow([h[1]-b[1]],2))},0),j=-(i/g),k=g+j;return k},i=g.reduce(function(a,b){var c=h(b);return a.value>c?a:{move:b,value:c}},{move:g[0],value:h(g[0])});return{pass:!1,move:i.move}},d=function(a,b,c,d){},e={Default:c,Idiotic:b,Easy:c,Medium:d};return{AgentNames:function(){return Object.keys(e)},Agent:function(a){return e[a]}}}]),angular.module("bloqusApp").factory("ScoreFactory",["$firebaseObject","localStorageService",function(a,b){var c=function(a){var b=0,c=0,d=0,e=0,f=0;for(var g in a)for(var h=0;h<a[g].length;h++)"R"==a[g][h]&&b++,"B"==a[g][h]&&c++,"G"==a[g][h]&&d++,"Y"==a[g][h]&&e++,"N"==a[g][h]&&f++;return{Red:b,Blue:c,Yellow:e,Green:d}};return c}]),angular.module("bloqusApp").filter("capital",function(){return function(a){return a?a[0].toUpperCase()+a.split("").splice(1,a.length).join(""):""}}),angular.module("bloqusApp").filter("reverse",function(){return function(a){return angular.isArray(a)?a.slice().reverse():[]}}),function(a){function b(){return"ondrag"in document.createElement("a")}if(!b())return void a.module("ang-drag-drop",[]);window.jQuery&&-1==window.jQuery.event.props.indexOf("dataTransfer")&&window.jQuery.event.props.push("dataTransfer");var c;a.module("ang-drag-drop",[]).directive("uiDraggable",["$parse","$rootScope","$dragImage",function(b,d,e){return function(f,g,h){function i(a){setTimeout(function(){g.unbind("$destroy",i)},0);var c=h.dragChannel||"defaultchannel";if(d.$broadcast("ANGULAR_DRAG_END",c),a.dataTransfer&&"none"!==a.dataTransfer.dropEffect)if(h.onDropSuccess){var e=b(h.onDropSuccess);f.$evalAsync(function(){e(f,{$event:a})})}else if(h.onDropFailure){var e=b(h.onDropFailure);f.$evalAsync(function(){e(f,{$event:a})})}g.removeClass(n)}function j(j){var o=!m||l.classList.contains(k);if(o){var p=h.dragChannel||"defaultchannel",q="";h.drag&&(q=f.$eval(h.drag));var r=a.toJson({data:q,channel:p}),s=h.dragImage||null;if(g.addClass(n),g.bind("$destroy",i),s){var t=b(h.dragImage);f.$apply(function(){var b=t(f,{$event:j});if(b&&(a.isString(b)&&(b=e.generate(b)),b.image)){var c=b.xOffset||0,d=b.yOffset||0;j.dataTransfer.setDragImage(b.image,c,d)}})}j.dataTransfer.setData("dataToSend",r),c=a.fromJson(r),j.dataTransfer.effectAllowed="copyMove",d.$broadcast("ANGULAR_DRAG_START",p,c.data)}else j.preventDefault()}var k,l,m=!1,n=h.draggingClass||"on-dragging";g.attr("draggable",!1),h.$observe("uiDraggable",function(a){a?g.attr("draggable",a):g.removeAttr("draggable")}),a.isString(h.dragHandleClass)&&(m=!0,k=h.dragHandleClass.trim()||"drag-handle",g.bind("mousedown",function(a){l=a.target})),g.bind("dragend",i),g.bind("dragstart",j)}}]).directive("uiOnDrop",["$parse","$rootScope",function(b,d){return function(e,f,g){function h(a){a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation();var c=b(g.uiOnDragOver);return e.$evalAsync(function(){c(e,{$event:a,$channel:o})}),a.dataTransfer.dropEffect=a.shiftKey?"copy":"move",!1}function i(a){a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation(),n--,0==n&&(e.$evalAsync(function(){s(e,{$event:a})}),f.removeClass(r));var c=b(g.uiOnDragLeave);e.$evalAsync(function(){c(e,{$event:a,$channel:o})})}function j(a){a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation(),n++;var c=b(g.uiOnDragEnter);e.$evalAsync(function(){c(e,{$event:a,$channel:o})}),d.$broadcast("ANGULAR_HOVER",p),e.$evalAsync(function(){t(e,{$event:a})}),f.addClass(r)}function k(c){c.preventDefault&&c.preventDefault(),c.stopPropagation&&c.stopPropagation();var d=c.dataTransfer.getData("dataToSend");d=a.fromJson(d);var h=b(g.uiOnDrop);e.$evalAsync(function(){h(e,{$data:d.data,$event:c,$channel:d.channel})}),f.removeClass(q),n=0}function l(a,b){if("*"===b)return!0;var c=new RegExp("(\\s|[,])+("+a+")(\\s|[,])+","i");return c.test(","+b+",")}function m(a){return a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation(),a.dataTransfer.dropEffect="none",!1}var n=0,o=g.dropChannel||"defaultchannel",p="",q=g.dragEnterClass||"on-drag-enter",r=g.dragHoverClass||"on-drag-hover",s=b(g.onDragEnter),t=b(g.onDragLeave),u=d.$on("ANGULAR_DRAG_START",function(a,d){if(p=d,l(d,o)){if(g.dropValidate){var n=b(g.dropValidate),r=n(e,{$data:c.data,$channel:c.channel});if(!r)return f.bind("dragover",m),f.bind("dragenter",m),f.bind("dragleave",m),void f.bind("drop",m)}f.bind("dragover",h),f.bind("dragenter",j),f.bind("dragleave",i),f.bind("drop",k),f.addClass(q)}else f.bind("dragover",m),f.bind("dragenter",m),f.bind("dragleave",m),f.bind("drop",m)}),v=d.$on("ANGULAR_DRAG_END",function(a,b){p="",l(b,o)&&(f.unbind("dragover",h),f.unbind("dragenter",j),f.unbind("dragleave",i),f.unbind("drop",k),f.removeClass(r),f.removeClass(q)),f.unbind("dragover",m),f.unbind("dragenter",m),f.unbind("dragleave",m),f.unbind("drop",m)}),w=d.$on("ANGULAR_HOVER",function(a,b){l(b,o)&&f.removeClass(r)});e.$on("$destroy",function(){u(),v(),w()}),g.$observe("dropChannel",function(a){a&&(o=a)})}}]).constant("$dragImageConfig",{height:20,width:200,padding:10,font:"bold 11px Arial",fontColor:"#eee8d5",backgroundColor:"#93a1a1",xOffset:0,yOffset:0}).service("$dragImage",["$dragImageConfig",function(b){function c(a,b,c){var e=a.measureText(b).width;if(e<c.width)return b;for(;e+c.padding>c.width;)b=b.substring(0,b.length-1),e=a.measureText(b+d).width;return b+d}var d="â€¦";this.generate=function(d,e){var f=a.extend({},b,e||{}),g=document.createElement("canvas");g.height=f.height,g.width=f.width;var h=g.getContext("2d");h.fillStyle=f.backgroundColor,h.fillRect(0,0,f.width,f.height),h.font=f.font,h.fillStyle=f.fontColor;var i=c(h,d,f);h.fillText(i,4,f.padding+4);var j=new Image;return j.src=g.toDataURL(),{image:j,xOffset:f.xOffset,yOffset:f.yOffset}}}])}(angular),function(){function a(){var a={array2dFill:function(a,b,c){for(var d=[],e=0;a>e;e++){d.push([]);for(var f=0;b>f;f++)d[e].push(c(e,f))}return d},specIndexOf:function(a,b){for(var c=0;c<a.length;c++)if(a[c][0]===b[0]&&a[c][1]===b[1])return c;return-1},sameArrElements:function(a,b){if(a.length!=b.length)return!1;for(var c=a.slice(),d=b.slice(),e=0;e<c.length;e++){if(-1===this.specIndexOf(d,c[e]))return!1;if(-1===this.specIndexOf(c,d[e]))return!1}return!0},deepEquals:function(a,b){var c=this;return Array.isArray(a)?a.every(function(d,e){return c.deepEquals(a[e],b[e])}):a==b},addLocations:function(a,b){return[a[0]+b[0],a[1]+b[1]]}},b=function(a,b,c){this.piece=a,this.location=b,this.color=c};b.prototype.occupies=function(){var b=this;return this.piece.getPieceWithOrientation().map(function(c){return a.addLocations(c,b.location)})},b.prototype.adjacencies=function(){var b=[[1,0],[-1,0],[0,1],[0,-1]],c=this.occupies();return c.reduce(function(c,d){return c.concat(b.map(function(b){return a.addLocations(d,b)}))},[]).filter(function(b,c,d){return a.specIndexOf(d,b)==c}).filter(function(b,d,e){return-1==a.specIndexOf(c,b)})},b.prototype.legalDiagonals=function(){var b=[[1,1],[-1,-1],[-1,1],[1,-1]],c=this.occupies(),d=this.adjacencies();return c.reduce(function(c,d){return c.concat(b.map(function(b){return a.addLocations(d,b)}))},[]).filter(function(b,c,d){return a.specIndexOf(d,b)==c}).filter(function(b,d,e){return-1==a.specIndexOf(c,b)}).filter(function(b,c,e){return-1==a.specIndexOf(d,b)})},b.prototype.equals=function(b){return a.sameArrElements(this.occupies(),b.occupies())&&b.color==this.color};var c=function(){this.flipped=!1,this.rotated=0,this.shape=[]};c.prototype.flip=function(){this.flipped=!this.flipped},c.prototype.rotateClockwise=function(){this.rotated-=90,this.rotated<0&&(this.rotated+=360)},c.prototype.rotateCounterClockwise=function(){this.rotated+=90,this.rotated>360&&(this.rotated-=360)},c.prototype._rotate=function(a,b){var c=a[0],d=a[1];return 0==b?[c,d]:90==b?[-d,c]:180==b?[-c,-d]:270==b?[d,-c]:void 0},c.prototype.getPieceWithAlternateOrientation=function(a,b){var c=this,d=1e3,e=1e3;return this.shape.map(function(b){return a?[b[0],-b[1]]:b}).map(function(a){return c._rotate(a,b)}).map(function(a){return d=Math.min(a[0],d),e=Math.min(a[1],e),a}).map(function(a){return[a[0]-d,a[1]-e]})},c.prototype.getPieceWithOrientation=function(){return this.getPieceWithAlternateOrientation(this.flipped,this.rotated)},c.prototype.sameShapeAtAll=function(b){for(var c=this.allPieceOrientations(),d=b.allPieceOrientations(),e=0,f=c.length;f>e;e++)for(var g=0,h=d.length;h>g;g++)if(a.sameArrElements(c[e],d[g]))return!0;return!1},c.prototype.allPieceOrientations=function(){for(var a=[],b=0;1>=b;b++)for(var c=0;360>c;c+=90)a.push(this.getPieceWithAlternateOrientation(b,c));return a};var d=function(b){var d=[[0,1],[1,0],[-1,0],[0,-1]],e=[new c];e[0].shape=[[10,10]];for(var f=1;b>f;f++){for(var g=e.length,h=0;g>h;h++)for(var i=e[h],j=0;j<i.shape.length;j++)for(var k=i.shape[j],l=0;l<d.length;l++){var m=[d[l][0]+k[0],d[l][1]+k[1]];if(-1==a.specIndexOf(i.shape,m)&&m[0]>=0&&m[1]>=0){var n=i.shape.slice();n.push(m);var o=new c;o.shape=n,e.push(o)}}for(var p=[],q=0;q<e.length;q++)p.some(function(a){return a.sameShapeAtAll(e[q])})||p.push(e[q]);e=p}for(var h=0;h<e.length;h++){var n=e[h].getPieceWithOrientation();e[h].shape=n}return e},e=function(b){this.dimensions=b,this.currentTurn="",this.board=a.array2dFill(b,b,function(){return"N"})};e.prototype.getBoard=function(){return this.board},e.prototype.getBoardSpot=function(a,b){return a>this.dimensions-1||b>this.dimensions-1||0>a||0>b?"N":this.board[a][b]},e.prototype.setBoardSpot=function(a,b,c){this.board[a][b]=c},e.prototype.liberties=function(b){for(var c=this,d=[],e=[[1,0],[0,1],[-1,0],[0,-1]],f=[[1,-1],[1,1],[-1,1],[-1,-1]],g=0;g<this.board.length;g++)for(var h=0;h<this.board.length;h++){var i=[g,h],j=this.getBoardSpot(i[0],i[1]);if(j===b)for(var k=0;k<f.length;k++){var l=[i[0]+f[k][0],i[1]+f[k][1]];if("N"===this.getBoardSpot(l[0],l[1])){for(var m=!0,n=0;n<e.length;n++){var o=[l[0]+e[n][0],l[1]+e[n][1]];if(this.getBoardSpot(o[0],o[1])===b){m=!1;break}}m&&d.push(l)}}}return"B"==b&&"N"==this.getBoardSpot(0,0)&&d.push([0,0]),"Y"==b&&"N"==this.getBoardSpot(this.dimensions-1,0)&&d.push([this.dimensions-1,0]),"R"==b&&this.getBoardSpot(this.dimensions-1,this.dimensions-1)&&d.push([this.dimensions-1,this.dimensions-1]),"G"==b&&this.getBoardSpot(0,this.dimensions-1)&&d.push([0,this.dimensions-1]),d=d.filter(function(b,d,e){return a.specIndexOf(e,b)==d&&b[0]>=0&&b[1]>=0&&b[0]<c.dimensions&&b[1]<c.dimensions})},e.prototype.doMove=function(a){if(this.isLegal(a)){for(var b=a.occupies(),c=0;c<b.length;c++){var d=b[c];this.setBoardSpot(d[0],d[1],a.color)}return!0}return!1},e.prototype.isLegal=function(a){for(var b=a.occupies(),c=0;c<b.length;c++){var d=b[c];if(d[0]<0||d[0]>=this.dimensions||d[1]<0||d[1]>=this.dimensions)return!1;if("N"!==this.getBoardSpot(d[0],d[1]))return!1}for(var e=a.adjacencies(),c=0;c<e.length;c++){var d=e[c];if(this.getBoardSpot(d[0],d[1])==a.color)return!1}for(var f=a.legalDiagonals(),c=0;c<f.length;c++){var d=f[c];if("B"==a.color&&-1==d[0]&&-1==d[1])return!0;if("Y"==a.color&&d[0]==this.dimensions&&-1==d[1])return!0;if("R"==a.color&&d[0]==this.dimensions&&d[1]==this.dimensions)return!0;if("G"==a.color&&-1==d[0]&&d[1]==this.dimensions)return!0;if(this.getBoardSpot(d[0],d[1])==a.color)return!0}return!1},e.prototype.allLegalMovesForPieces=function(a,b){for(var c=[],d=0;d<a.length;d++)c=c.concat(this.allLegalMovesForPiece(a[d],b));return c},e.prototype.allLegalMovesForPiece=function(a,d){for(var e=this.liberties(d),f=[],g=0;g<e.length;g++)for(var h=e[g],i=0;1>=i;i++)for(var j=!!i,k=0;360>k;k+=90){var l=new c;l.shape=a.shape,l.flipped=j,l.rotated=k;for(var m=new b(l,h,d),n=m.occupies().map(function(a){return[h[0]+h[0]-a[0],h[1]+h[1]-a[1]]}),o=0;o<n.length;o++){var p=new b(l,n[o],d);this.isLegal(p)&&f.push(p)}}for(var q=[],r=0;r<f.length;r++){for(var s=!0,t=0;r>t;t++)if(f[r].equals(f[t])){s=!1;break}s&&q.push(f[r])}return q},e.prototype.consumeFire=function(a){for(var b=a.row0.length,c=[],d=0;b>d;d++){c.push([]);for(var e=0;b>e;e++)this.setBoardSpot(e,d,a["row"+d].charAt(e))}},e.prototype.emitFire=function(){for(var a={},b=this.dimensions,c=0;b>c;c++){a["row"+c]="";for(var d=0;b>d;d++)a["row"+c]=a["row"+c]+this.getBoardSpot(d,c)}return a},e.prototype.isOver=function(){};var f={helper:a,Move:b,Piece:c,PiecesGenerator:d,Board:e};return f}angular.module("bloqusApp").factory("LogicFactory",a)}(),angular.module("bloqusApp").config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("main",{url:"/",templateUrl:"views/main.html",controller:"MainCtrl"}).state("lobby",{url:"/lobby/:currentId/:shareId",templateUrl:"views/lobby.html",controller:"LobbyCtrl"}).state("gameboard",{url:"/game/",params:{game:{firebaseId:"",player:""}},templateUrl:"views/gameboard.html",controller:"GameCtrl"}).state("gameover",{url:"/gameover",templateUrl:"views/gameover.html",params:{game:{}},controller:"GameOverCtrl"})}]),angular.module("bloqusApp").controller("GameOverCtrl",["$scope","$state","SignInFactory","$firebaseObject","$stateParams","ScoreFactory",function(a,b,c,d,e,f){var g=e.game.board;a.scoreObj=f(g)}]);